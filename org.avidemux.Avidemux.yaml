app-id: org.avidemux.Avidemux
branch: stable
runtime: org.kde.Platform
runtime-version: '5.12'
sdk: org.kde.Sdk
command: avidemux3_qt5
finish-args:
  - --socket=wayland
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=host # needed for jobs scheduler
  - --env=LD_LIBRARY_PATH=/app/lib/x86_64-linux-gnu/:/app/lib/i386-linux-gnu/:/app/lib64:/app/lib
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'
modules:
  - shared-modules/glu/glu-9.0.0.json
  - shared-modules/glew/glew.json

  - name: yasm # need for bundled ffmpeg 3.3
    buildsystem: cmake-ninja
    builddir: true
    cleanup:
      - '*'
    sources:
      - type: archive
        url: http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz
        sha256: 3dce6601b495f5b3d45b59f7d2492a340ee7e84b5beca17e48f862502bd5603f

  - name: x264
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20180807-2245-stable.tar.bz2
        sha256: 1439f1a054c87965089b646e77d16e1a8bf2f9687e4dd696ac518e44c7644c2a

  - name: x265
    buildsystem: cmake-ninja
    builddir: true
    subdir: source
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://bitbucket.org/multicoreware/x265/downloads/x265_3.0.tar.gz
        sha256: c5b9fc260cabbc4a81561a448f4ce9cad7218272b4011feabc3a6b751b2f0662

  - name: avidemux
    buildsystem: simple
    build-commands:
      - bash bootStrap.bash --prefix=/app
      - cp -R install/app/* /app
      - install -Dm644 -t /app/share/icons/hicolor/128x128/apps org.avidemux.Avidemux.png
      - desktop-file-edit --set-key=Icon --set-value=org.avidemux.Avidemux avidemux2.desktop
      - install -Dm644 avidemux2.desktop /app/share/applications/org.avidemux.Avidemux.desktop
      - sed -i 's|<id>avidemux2.desktop</id>|<id>org.avidemux.Avidemux</id>|' avidemux2.appdata.xml
      - sed -i 's|<binary>avidemux2_gtk</binary>|<binary>avidemux3_qt5</binary>|' avidemux2.appdata.xml
      - sed -i '30i <releases><release version=\"2.7.1\" date=\"2018-06-04\"/></releases>' avidemux2.appdata.xml
      - install -Dm644 avidemux2.appdata.xml /app/share/metainfo/org.avidemux.Avidemux.appdata.xml
    sources:
      - type: file
        path: org.avidemux.Avidemux.png
      - type: archive
        url: https://github.com/mean00/avidemux2/archive/2.7.1.tar.gz
        sha256: dfda3ad362e5b7191e9422315eda22ccd703a8d0d50106290143fefa8f88749e
      - type: patch
        path: patches/Qt-GL-Fix-OpenGL-with-Qt-5.12.0.patch
